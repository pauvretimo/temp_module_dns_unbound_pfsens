
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>DNS-based language dictionary &#8212; Unbound scriptable interface 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="EDNS options" href="example5.html" />
    <link rel="prev" title="Response modification" href="example3.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="example5.html" title="EDNS options"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="example3.html" title="Response modification"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Unbound scriptable interface 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Examples</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">DNS-based language dictionary</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="dns-based-language-dictionary">
<h1>DNS-based language dictionary<a class="headerlink" href="#dns-based-language-dictionary" title="Permalink to this headline">¶</a></h1>
<p>This example shows how to create a simple language dictionary based on <strong>DNS</strong>
service within 15 minutes. The translation will be performed using TXT resource
records.</p>
<section id="key-parts">
<h2>Key parts<a class="headerlink" href="#key-parts" title="Permalink to this headline">¶</a></h2>
<section id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h3>
<p>On <strong>init()</strong> module loads dictionary from a text file containing records in
<code class="docutils literal notranslate"><span class="pre">word</span> <span class="pre">[tab]</span> <span class="pre">translation</span></code> format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
   <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;pythonmod: dict init&quot;</span><span class="p">)</span>
   <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;examples/dict_data.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
   <span class="o">...</span>
</pre></div>
</div>
<p>The suitable file can be found at <a class="reference external" href="http://slovnik.zcu.cz">http://slovnik.zcu.cz</a></p>
</section>
<section id="dns-query-and-word-lookup">
<h3>DNS query and word lookup<a class="headerlink" href="#dns-query-and-word-lookup" title="Permalink to this headline">¶</a></h3>
<p>Let’s define the following format od DNS queries:
<code class="docutils literal notranslate"><span class="pre">word1[.]word2[.]</span> <span class="pre">...</span> <span class="pre">wordN[.]{en,cs}[._dict_.cz.]</span></code>.
Word lookup is done by simple <code class="docutils literal notranslate"><span class="pre">dict</span></code> lookup from broken DNS request.
Query name is divided into a list of labels. This list is accessible as
<code class="docutils literal notranslate"><span class="pre">qname_list</span></code> attribute.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aword</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span> <span class="c1">#skip last four labels</span>
<span class="n">adict</span> <span class="o">=</span> <span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_list</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c1">#get 4th label from the end</span>

<span class="n">words</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#list of words</span>
<span class="k">if</span> <span class="p">(</span><span class="n">adict</span> <span class="o">==</span> <span class="s2">&quot;en&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">aword</span> <span class="ow">in</span> <span class="n">en_dict</span><span class="p">):</span>
   <span class="n">words</span> <span class="o">=</span> <span class="n">en_dict</span><span class="p">[</span><span class="n">aword</span><span class="p">]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">adict</span> <span class="o">==</span> <span class="s2">&quot;cs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">aword</span> <span class="ow">in</span> <span class="n">cz_dict</span><span class="p">):</span>
   <span class="n">words</span> <span class="o">=</span> <span class="n">cz_dict</span><span class="p">[</span><span class="n">aword</span><span class="p">]</span> <span class="c1"># CS -&gt; EN</span>
</pre></div>
</div>
<p>In the first step, we get a string in the form:
<code class="docutils literal notranslate"><span class="pre">word1[space]word2[space]...word[space]</span></code>.
In the second assignment, fourth label from the end is obtained. This label
should contains <em>“cs”</em> or <em>“en”</em>. This label determines the direction of
translation.</p>
</section>
<section id="forming-of-a-dns-reply">
<h3>Forming of a DNS reply<a class="headerlink" href="#forming-of-a-dns-reply" title="Permalink to this headline">¶</a></h3>
<p>DNS reply is formed only on valid match and added as TXT answer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span> <span class="o">=</span> <span class="n">DNSMessage</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_str</span><span class="p">,</span> <span class="n">RR_TYPE_TXT</span><span class="p">,</span> <span class="n">RR_CLASS_IN</span><span class="p">,</span> <span class="n">PKT_AA</span><span class="p">)</span>

<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> 300 IN TXT </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_str</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\&quot;</span><span class="s2">&quot;</span><span class="p">)))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">set_return_msg</span><span class="p">(</span><span class="n">qstate</span><span class="p">):</span>
    <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_ERROR</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="n">qstate</span><span class="o">.</span><span class="n">return_rcode</span> <span class="o">=</span> <span class="n">RCODE_NOERROR</span>
<span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_FINISHED</span>
<span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>In the first step, a <a class="reference internal" href="../modules/struct.html#DNSMessage" title="DNSMessage"><code class="xref py py-class docutils literal notranslate"><span class="pre">DNSMessage</span></code></a> instance is created for a given query
<em>(type TXT)</em>.
The fourth argument specifies the flags <em>(authoritative answer)</em>.
In the second step, we append TXT records containing the translation <em>(on the
right side of RR)</em>.
Then, the response is finished and <code class="docutils literal notranslate"><span class="pre">qstate.return_msg</span></code> contains new response.
If no error, the module sets <a class="reference internal" href="../modules/struct.html#module_qstate.return_rcode" title="module_qstate.return_rcode"><code class="xref py py-attr docutils literal notranslate"><span class="pre">module_qstate.return_rcode</span></code></a> and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">module_qstate.ext_state</span></code>.</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p>create <a class="reference internal" href="../modules/struct.html#DNSMessage" title="DNSMessage"><code class="xref py py-class docutils literal notranslate"><span class="pre">DNSMessage</span></code></a> instance</p></li>
<li><p>append TXT records containing the translation</p></li>
<li><p>set response to <code class="docutils literal notranslate"><span class="pre">qstate.return_msg</span></code></p></li>
</ol>
</section>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>Run the Unbound server:</p>
<p><code class="docutils literal notranslate"><span class="pre">root&#64;localhost&gt;unbound</span> <span class="pre">-dv</span> <span class="pre">-c</span> <span class="pre">./test-dict.conf</span></code></p>
<p>In case you use own configuration file, don’t forget to enable Python module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span><span class="o">-</span><span class="n">config</span><span class="p">:</span> <span class="s2">&quot;validator python iterator&quot;</span>
</pre></div>
</div>
<p>and use valid script path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span><span class="o">-</span><span class="n">script</span><span class="p">:</span> <span class="s2">&quot;./examples/dict.py&quot;</span>
</pre></div>
</div>
<p>The translation from english word <em>“a bar fly”</em> to Czech can be done by doing:</p>
<p><code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;dig</span> <span class="pre">TXT</span> <span class="pre">&#64;127.0.0.1</span> <span class="pre">a.bar.fly.en._dict_.cz</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="n">server</span> <span class="n">found</span><span class="p">)</span>
<span class="p">;;</span> <span class="k">global</span> <span class="n">options</span><span class="p">:</span>  <span class="n">printcmd</span>
<span class="p">;;</span> <span class="n">Got</span> <span class="n">answer</span><span class="p">:</span>
<span class="p">;;</span> <span class="o">-&gt;&gt;</span><span class="n">HEADER</span><span class="o">&lt;&lt;-</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">QUERY</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">NOERROR</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">48691</span>
<span class="p">;;</span> <span class="n">flags</span><span class="p">:</span> <span class="n">aa</span> <span class="n">rd</span> <span class="n">ra</span><span class="p">;</span> <span class="n">QUERY</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ANSWER</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTHORITY</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ADDITIONAL</span><span class="p">:</span> <span class="mi">0</span>

<span class="p">;;</span> <span class="n">QUESTION</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="p">;</span><span class="n">a</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">en</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>    <span class="n">IN</span>  <span class="n">TXT</span>

<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">a</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">en</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span> <span class="mi">300</span> <span class="n">IN</span>  <span class="n">TXT</span> <span class="s2">&quot;barov</span><span class="se">\253</span><span class="s2"> povale</span><span class="se">\232</span><span class="s2">&quot;</span>

<span class="p">;;</span> <span class="n">Query</span> <span class="n">time</span><span class="p">:</span> <span class="mi">5</span> <span class="n">msec</span>
<span class="p">;;</span> <span class="n">SERVER</span><span class="p">:</span> <span class="mf">127.0.0.1</span><span class="c1">#53(127.0.0.1)</span>
<span class="p">;;</span> <span class="n">WHEN</span><span class="p">:</span> <span class="n">Mon</span> <span class="n">Jan</span> <span class="mi">01</span> <span class="mi">17</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">18</span> <span class="mi">2009</span>
<span class="p">;;</span> <span class="n">MSG</span> <span class="n">SIZE</span>  <span class="n">rcvd</span><span class="p">:</span> <span class="mi">67</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;dig</span> <span class="pre">TXT</span> <span class="pre">&#64;127.0.0.1</span> <span class="pre">nic.cs._dict_.cz</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">;</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="mf">9.5.0</span><span class="o">-</span><span class="n">P2</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="n">TXT</span> <span class="o">@</span><span class="mf">127.0.0.1</span> <span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span>
<span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="n">server</span> <span class="n">found</span><span class="p">)</span>
<span class="p">;;</span> <span class="k">global</span> <span class="n">options</span><span class="p">:</span>  <span class="n">printcmd</span>
<span class="p">;;</span> <span class="n">Got</span> <span class="n">answer</span><span class="p">:</span>
<span class="p">;;</span> <span class="o">-&gt;&gt;</span><span class="n">HEADER</span><span class="o">&lt;&lt;-</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">QUERY</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">NOERROR</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">58710</span>
<span class="p">;;</span> <span class="n">flags</span><span class="p">:</span> <span class="n">aa</span> <span class="n">rd</span> <span class="n">ra</span><span class="p">;</span> <span class="n">QUERY</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ANSWER</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="n">AUTHORITY</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ADDITIONAL</span><span class="p">:</span> <span class="mi">0</span>

<span class="p">;;</span> <span class="n">QUESTION</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="p">;</span><span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>      <span class="n">IN</span>  <span class="n">TXT</span>

<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>   <span class="mi">300</span> <span class="n">IN</span>  <span class="n">TXT</span> <span class="s2">&quot;aught&quot;</span>
<span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>   <span class="mi">300</span> <span class="n">IN</span>  <span class="n">TXT</span> <span class="s2">&quot;naught&quot;</span>
<span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>   <span class="mi">300</span> <span class="n">IN</span>  <span class="n">TXT</span> <span class="s2">&quot;nihil&quot;</span>
<span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>   <span class="mi">300</span> <span class="n">IN</span>  <span class="n">TXT</span> <span class="s2">&quot;nix&quot;</span>
<span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>   <span class="mi">300</span> <span class="n">IN</span>  <span class="n">TXT</span> <span class="s2">&quot;nothing&quot;</span>
<span class="n">nic</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">_dict_</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>   <span class="mi">300</span> <span class="n">IN</span>  <span class="n">TXT</span> <span class="s2">&quot;zilch&quot;</span>

<span class="p">;;</span> <span class="n">Query</span> <span class="n">time</span><span class="p">:</span> <span class="mi">0</span> <span class="n">msec</span>
<span class="p">;;</span> <span class="n">SERVER</span><span class="p">:</span> <span class="mf">127.0.0.1</span><span class="c1">#53(127.0.0.1)</span>
<span class="p">;;</span> <span class="n">WHEN</span><span class="p">:</span> <span class="n">Mon</span> <span class="n">Jan</span> <span class="mi">01</span> <span class="mi">17</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">39</span> <span class="mi">2009</span>
<span class="p">;;</span> <span class="n">MSG</span> <span class="n">SIZE</span>  <span class="n">rcvd</span><span class="p">:</span> <span class="mi">143</span>

<span class="n">Proof</span> <span class="n">that</span> <span class="n">the</span> <span class="n">unbound</span> <span class="n">still</span> <span class="n">works</span> <span class="k">as</span> <span class="n">resolver</span><span class="o">.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;dig</span> <span class="pre">A</span> <span class="pre">&#64;127.0.0.1</span> <span class="pre">www.nic.cz</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="n">server</span> <span class="n">found</span><span class="p">)</span>
<span class="p">;;</span> <span class="k">global</span> <span class="n">options</span><span class="p">:</span>  <span class="n">printcmd</span>
<span class="p">;;</span> <span class="n">Got</span> <span class="n">answer</span><span class="p">:</span>
<span class="p">;;</span> <span class="o">-&gt;&gt;</span><span class="n">HEADER</span><span class="o">&lt;&lt;-</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">QUERY</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">NOERROR</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">19996</span>
<span class="p">;;</span> <span class="n">flags</span><span class="p">:</span> <span class="n">qr</span> <span class="n">rd</span> <span class="n">ra</span><span class="p">;</span> <span class="n">QUERY</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ANSWER</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTHORITY</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ADDITIONAL</span><span class="p">:</span> <span class="mi">5</span>

<span class="p">;;</span> <span class="n">QUESTION</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="p">;</span><span class="n">www</span><span class="o">.</span><span class="n">nic</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>            <span class="n">IN</span>  <span class="n">A</span>

<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">www</span><span class="o">.</span><span class="n">nic</span><span class="o">.</span><span class="n">cz</span><span class="o">.</span>     <span class="mi">1662</span>    <span class="n">IN</span>  <span class="n">A</span>   <span class="mf">217.31.205.50</span>

<span class="p">;;</span> <span class="n">AUTHORITY</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="o">...</span>
</pre></div>
</div>
</section>
<section id="complete-source-code">
<h2>Complete source code<a class="headerlink" href="#complete-source-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd"> calc.py: DNS-based czech-english dictionary</span>

<span class="sd"> Copyright (c) 2009, Zdenek Vasicek (vasicek AT fit.vutbr.cz)</span>
<span class="sd">                     Marek Vavrusa  (xvavru00 AT stud.fit.vutbr.cz)</span>

<span class="sd"> This software is open source.</span>
<span class="sd"> </span>
<span class="sd"> Redistribution and use in source and binary forms, with or without</span>
<span class="sd"> modification, are permitted provided that the following conditions</span>
<span class="sd"> are met:</span>
<span class="sd"> </span>
<span class="sd">    * Redistributions of source code must retain the above copyright notice,</span>
<span class="sd">      this list of conditions and the following disclaimer.</span>
<span class="sd"> </span>
<span class="sd">    * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="sd">      this list of conditions and the following disclaimer in the documentation</span>
<span class="sd">      and/or other materials provided with the distribution.</span>
<span class="sd"> </span>
<span class="sd">    * Neither the name of the organization nor the names of its</span>
<span class="sd">      contributors may be used to endorse or promote products derived from this</span>
<span class="sd">      software without specific prior written permission.</span>

<span class="sd"> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="sd"> &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</span>
<span class="sd"> TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="sd"> PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE</span>
<span class="sd"> LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="sd"> CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="sd"> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="sd"> INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="sd"> CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="sd"> ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="sd"> POSSIBILITY OF SUCH DAMAGE.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">cz_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">en_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
   <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;pythonmod: dict init&quot;</span><span class="p">)</span>
   <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;examples/dict_data.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
         <span class="n">itm</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="k">continue</span>
         <span class="n">en</span><span class="p">,</span><span class="n">cs</span> <span class="o">=</span> <span class="n">itm</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

         <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cs</span> <span class="ow">in</span> <span class="n">cz_dict</span><span class="p">):</span>
            <span class="n">cz_dict</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">en</span><span class="p">]</span>     <span class="c1"># [cs] = en</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">cz_dict</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">en</span><span class="p">)</span> <span class="c1"># [cs] = en</span>

         <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">en</span> <span class="ow">in</span> <span class="n">en_dict</span><span class="p">):</span>
            <span class="n">en_dict</span><span class="p">[</span><span class="n">en</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cs</span><span class="p">]</span>     <span class="c1"># [en] = cs</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">en_dict</span><span class="p">[</span><span class="n">en</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="c1"># [en] = cs</span>

   <span class="k">finally</span><span class="p">:</span>
      <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
   <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">deinit</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
   <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;pythonmod: dict deinit&quot;</span><span class="p">)</span>
   <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">qstate</span><span class="p">,</span> <span class="n">qdata</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_NEW</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_PASS</span><span class="p">):</span>

       <span class="k">if</span> <span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;._dict_.cz.&quot;</span><span class="p">):</span>
        
         <span class="n">aword</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
         <span class="n">adict</span> <span class="o">=</span> <span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_list</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

         <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;pythonmod: dictionary look up; word:</span><span class="si">%s</span><span class="s2"> dict:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aword</span><span class="p">,</span><span class="n">adict</span><span class="p">))</span>

         <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">adict</span> <span class="o">==</span> <span class="s2">&quot;en&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">aword</span> <span class="ow">in</span> <span class="n">en_dict</span><span class="p">):</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">en_dict</span><span class="p">[</span><span class="n">aword</span><span class="p">]</span> <span class="c1"># EN -&gt; CS</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">adict</span> <span class="o">==</span> <span class="s2">&quot;cs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">aword</span> <span class="ow">in</span> <span class="n">cz_dict</span><span class="p">):</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">cz_dict</span><span class="p">[</span><span class="n">aword</span><span class="p">]</span> <span class="c1"># CS -&gt; EN</span>

         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qtype</span> <span class="o">==</span> <span class="n">RR_TYPE_TXT</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qtype</span> <span class="o">==</span> <span class="n">RR_TYPE_ANY</span><span class="p">)):</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">DNSMessage</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_str</span><span class="p">,</span> <span class="n">RR_TYPE_TXT</span><span class="p">,</span> <span class="n">RR_CLASS_IN</span><span class="p">,</span> <span class="n">PKT_RD</span> <span class="o">|</span> <span class="n">PKT_RA</span> <span class="o">|</span> <span class="n">PKT_AA</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> 300 IN TXT </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">qinfo</span><span class="o">.</span><span class="n">qname_str</span><span class="p">,</span><span class="n">w</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\\\&quot;</span><span class="s2">&quot;</span><span class="p">)))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">set_return_msg</span><span class="p">(</span><span class="n">qstate</span><span class="p">):</span>
               <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_ERROR</span> 
               <span class="k">return</span> <span class="kc">True</span>

            <span class="n">qstate</span><span class="o">.</span><span class="n">return_rcode</span> <span class="o">=</span> <span class="n">RCODE_NOERROR</span>
            <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_FINISHED</span> 
            <span class="k">return</span> <span class="kc">True</span>

         <span class="k">else</span><span class="p">:</span>
            <span class="n">qstate</span><span class="o">.</span><span class="n">return_rcode</span> <span class="o">=</span> <span class="n">RCODE_SERVFAIL</span>
            <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_FINISHED</span> 
            <span class="k">return</span> <span class="kc">True</span>

       <span class="k">else</span><span class="p">:</span> <span class="c1">#Pass on the unknown query to the iterator</span>
         <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_WAIT_MODULE</span> 
         <span class="k">return</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_MODDONE</span><span class="p">:</span> <span class="c1">#the iterator has finished</span>
         <span class="c1">#we don&#39;t need modify result</span>
         <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_FINISHED</span>
         <span class="k">return</span> <span class="kc">True</span>

    <span class="n">log_err</span><span class="p">(</span><span class="s2">&quot;pythonmod: Unknown event&quot;</span><span class="p">)</span>
    <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_ERROR</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">inform_super</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">qstate</span><span class="p">,</span> <span class="n">superqstate</span><span class="p">,</span> <span class="n">qdata</span><span class="p">):</span>
   <span class="k">return</span> <span class="kc">True</span>

</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">DNS-based language dictionary</a><ul>
<li><a class="reference internal" href="#key-parts">Key parts</a><ul>
<li><a class="reference internal" href="#initialization">Initialization</a></li>
<li><a class="reference internal" href="#dns-query-and-word-lookup">DNS query and word lookup</a></li>
<li><a class="reference internal" href="#forming-of-a-dns-reply">Forming of a DNS reply</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#complete-source-code">Complete source code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="example3.html"
                        title="previous chapter">Response modification</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="example5.html"
                        title="next chapter">EDNS options</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="example5.html" title="EDNS options"
             >next</a> |</li>
        <li class="right" >
          <a href="example3.html" title="Response modification"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Unbound scriptable interface 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Examples</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">DNS-based language dictionary</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009, Zdenek Vasicek, Marek Vavrusa.
      Last updated on Nov 17, 2023.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>