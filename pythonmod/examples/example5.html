
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>EDNS options &#8212; Unbound scriptable interface 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Inplace callbacks" href="example6.html" />
    <link rel="prev" title="DNS-based language dictionary" href="example4.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="example6.html" title="Inplace callbacks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="example4.html" title="DNS-based language dictionary"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Unbound scriptable interface 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Examples</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">EDNS options</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="edns-options">
<h1>EDNS options<a class="headerlink" href="#edns-options" title="Permalink to this headline">¶</a></h1>
<p>This example shows how to interact with EDNS options.</p>
<p>When querying unbound with the EDNS option <code class="docutils literal notranslate"><span class="pre">65001</span></code> and data <code class="docutils literal notranslate"><span class="pre">0xc001</span></code> we
expect an answer with the same EDNS option code and data <code class="docutils literal notranslate"><span class="pre">0xdeadbeef</span></code>.</p>
<section id="key-parts">
<h2>Key parts<a class="headerlink" href="#key-parts" title="Permalink to this headline">¶</a></h2>
<p>This example relies on the following functionalities:</p>
<section id="registering-edns-options">
<h3>Registering EDNS options<a class="headerlink" href="#registering-edns-options" title="Permalink to this headline">¶</a></h3>
<p>By registering EDNS options we can tune unbound’s behavior when encountering a
query with a known EDNS option. The two available options are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bypass_cache_stage</span></code>: If set to <code class="docutils literal notranslate"><span class="pre">True</span></code> unbound will not try to answer
from cache. Instead execution is passed to the modules</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">no_aggregation</span></code>: If set to <code class="docutils literal notranslate"><span class="pre">True</span></code> unbound will consider this query
unique and will not aggregate it with similar queries</p></li>
</ul>
<p>Both values default to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">register_edns_option</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="mi">65001</span><span class="p">,</span> <span class="n">bypass_cache_stage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">no_aggregation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: Could not register EDNS option </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">65001</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="edns-option-lists">
<h3>EDNS option lists<a class="headerlink" href="#edns-option-lists" title="Permalink to this headline">¶</a></h3>
<p>EDNS option lists can be found in the <a class="reference internal" href="../modules/struct.html#module_qstate" title="module_qstate"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate</span></code></a> class. There are
four available lists in total:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../modules/struct.html#module_qstate.edns_opts_front_in" title="module_qstate.edns_opts_front_in"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate.edns_opts_front_in</span></code></a>: options that came from the client
side. <strong>Should not</strong> be changed</p></li>
<li><p><a class="reference internal" href="../modules/struct.html#module_qstate.edns_opts_back_out" title="module_qstate.edns_opts_back_out"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate.edns_opts_back_out</span></code></a>: options that will be sent to the
server side. Can be populated by edns literate modules</p></li>
<li><p><a class="reference internal" href="../modules/struct.html#module_qstate.edns_opts_back_in" title="module_qstate.edns_opts_back_in"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate.edns_opts_back_in</span></code></a>: options that came from the server
side. <strong>Should not</strong> be changed</p></li>
<li><p><a class="reference internal" href="../modules/struct.html#module_qstate.edns_opts_front_out" title="module_qstate.edns_opts_front_out"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate.edns_opts_front_out</span></code></a>: options that will be sent to the
client side. Can be populated by edns literate modules</p></li>
</ul>
<p>Each list element has the following members:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">code</span></code>: the EDNS option code;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code>: the EDNS option data.</p></li>
</ul>
<section id="reading-an-edns-option-list">
<h4>Reading an EDNS option list<a class="headerlink" href="#reading-an-edns-option-list" title="Permalink to this headline">¶</a></h4>
<p>The lists’ contents can be accessed in python by their <code class="docutils literal notranslate"><span class="pre">_iter</span></code> counterpart as
an iterator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in_iter</span><span class="p">:</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python:    Code: </span><span class="si">{}</span><span class="s2">, Data: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
</pre></div>
</div>
</section>
<section id="writing-to-an-edns-option-list">
<h4>Writing to an EDNS option list<a class="headerlink" href="#writing-to-an-edns-option-list" title="Permalink to this headline">¶</a></h4>
<p>By appending to an EDNS option list we can add new EDNS options. The new
element is going to be allocated in <a class="reference internal" href="../modules/struct.html#module_qstate.region" title="module_qstate.region"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate.region</span></code></a>. The data
<strong>must</strong> be represented with a python <code class="docutils literal notranslate"><span class="pre">bytearray</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;deadbeef&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_append</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_out</span><span class="p">,</span>
                       <span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">qstate</span><span class="o">.</span><span class="n">region</span><span class="p">):</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: Could not append EDNS option </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
</pre></div>
</div>
<p>We can also remove an EDNS option code from an EDNS option list.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_remove</span><span class="p">(</span><span class="n">edns_opt_list</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: Option code </span><span class="si">{}</span><span class="s2"> was not found in the &quot;</span>
             <span class="s2">&quot;list.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All occurrences of the EDNS option code will be removed from the list:</p>
</div>
</section>
</section>
<section id="controlling-other-modules-cache-behavior">
<h3>Controlling other modules’ cache behavior<a class="headerlink" href="#controlling-other-modules-cache-behavior" title="Permalink to this headline">¶</a></h3>
<p>During the modules’ operation, some modules may interact with the cache
(e.g., iterator). This behavior can be controlled by using the following
<a class="reference internal" href="../modules/struct.html#module_qstate" title="module_qstate"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate</span></code></a> flags:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../modules/struct.html#module_qstate.no_cache_lookup" title="module_qstate.no_cache_lookup"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate.no_cache_lookup</span></code></a>: Modules <em>operating after</em> this module
will not lookup the cache for an answer</p></li>
<li><p><a class="reference internal" href="../modules/struct.html#module_qstate.no_cache_store" title="module_qstate.no_cache_store"><code class="xref py py-class docutils literal notranslate"><span class="pre">module_qstate.no_cache_store</span></code></a>: Modules <em>operating after</em> this module
will not store the response in the cache</p></li>
</ul>
<p>Both values default to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">qstate</span><span class="p">,</span> <span class="n">qdata</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_NEW</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_PASS</span><span class="p">):</span>
        <span class="c1"># Detect if edns option code 56001 is present from the client side. If</span>
        <span class="c1"># so turn on the flags for cache management.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in</span><span class="p">):</span>
            <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: searching for edns option code 65001 during NEW &quot;</span>
                    <span class="s2">&quot;or PASS event &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in_iter</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">65001</span><span class="p">:</span>
                    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: found edns option code 65001&quot;</span><span class="p">)</span>
                    <span class="c1"># Instruct other modules to not lookup for an</span>
                    <span class="c1"># answer in the cache.</span>
                    <span class="n">qstate</span><span class="o">.</span><span class="n">no_cache_lookup</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: enabled no_cache_lookup&quot;</span><span class="p">)</span>

                    <span class="c1"># Instruct other modules to not store the answer in</span>
                    <span class="c1"># the cache.</span>
                    <span class="n">qstate</span><span class="o">.</span><span class="n">no_cache_store</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: enabled no_cache_store&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>Run the Unbound server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@localhost$ unbound -dv -c ./test-edns.conf
</pre></div>
</div>
<p>In case you use your own configuration file, don’t forget to enable the Python
module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span><span class="o">-</span><span class="n">config</span><span class="p">:</span> <span class="s2">&quot;validator python iterator&quot;</span>
</pre></div>
</div>
<p>and use a valid script path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span><span class="o">-</span><span class="n">script</span><span class="p">:</span> <span class="s2">&quot;./examples/edns.py&quot;</span>
</pre></div>
</div>
<p>Querying with EDNS option <code class="docutils literal notranslate"><span class="pre">65001:0xc001</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@localhost$ dig @localhost nlnetlabs.nl +ednsopt=65001:c001

; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; @localhost nlnetlabs.nl +ednsopt=65001:c001
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 33450
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; OPT=65001: de ad be ef (&quot;....&quot;)
;; QUESTION SECTION:
;nlnetlabs.nl.                  IN      A

;; ANSWER SECTION:
nlnetlabs.nl.           10200   IN      A       185.49.140.10

;; AUTHORITY SECTION:
nlnetlabs.nl.           10200   IN      NS      anyns.pch.net.
nlnetlabs.nl.           10200   IN      NS      ns.nlnetlabs.nl.
nlnetlabs.nl.           10200   IN      NS      ns-ext1.sidn.nl.
nlnetlabs.nl.           10200   IN      NS      sec2.authdns.ripe.net.

;; ADDITIONAL SECTION:
ns.nlnetlabs.nl.        10200   IN      AAAA    2a04:b900::8:0:0:60
ns.nlnetlabs.nl.        10200   IN      A       185.49.140.60

;; Query time: 10 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Mon Dec 05 14:50:56 CET 2016
;; MSG SIZE  rcvd: 212
</pre></div>
</div>
</section>
<section id="complete-source-code">
<h2>Complete source code<a class="headerlink" href="#complete-source-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd"> edns.py: python module showcasing EDNS option functionality.</span>

<span class="sd"> Copyright (c) 2016, NLnet Labs.</span>

<span class="sd"> This software is open source.</span>
<span class="sd"> </span>
<span class="sd"> Redistribution and use in source and binary forms, with or without</span>
<span class="sd"> modification, are permitted provided that the following conditions</span>
<span class="sd"> are met:</span>
<span class="sd"> </span>
<span class="sd">    * Redistributions of source code must retain the above copyright notice,</span>
<span class="sd">      this list of conditions and the following disclaimer.</span>
<span class="sd"> </span>
<span class="sd">    * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="sd">      this list of conditions and the following disclaimer in the documentation</span>
<span class="sd">      and/or other materials provided with the distribution.</span>
<span class="sd"> </span>
<span class="sd">    * Neither the name of the organization nor the names of its</span>
<span class="sd">      contributors may be used to endorse or promote products derived from this</span>
<span class="sd">      software without specific prior written permission.</span>

<span class="sd"> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="sd"> &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</span>
<span class="sd"> TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="sd"> PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE</span>
<span class="sd"> LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="sd"> CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="sd"> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="sd"> INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="sd"> CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="sd"> ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="sd"> POSSIBILITY OF SUCH DAMAGE.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1">#Try:</span>
<span class="c1"># - dig @localhost nlnetlabs.nl +ednsopt=65001:c001</span>
<span class="c1">#       This query will always reach the modules stage as EDNS option 65001 is</span>
<span class="c1">#       registered to bypass the cache response stage. It will also be handled</span>
<span class="c1">#       as a unique query because of the no_aggregation flag. This means that</span>
<span class="c1">#       it will not be aggregated with other queries for the same qinfo.</span>
<span class="c1">#       For demonstration purposes when option 65001 with hexdata &#39;c001&#39; is</span>
<span class="c1">#       sent from the client side this module will reply with the same code and</span>
<span class="c1">#       data &#39;deadbeef&#39;.</span>

<span class="c1"># Useful functions:</span>
<span class="c1">#   edns_opt_list_is_empty(edns_opt_list):</span>
<span class="c1">#       Check if the option list is empty.</span>
<span class="c1">#       Return True if empty, False otherwise.</span>
<span class="c1">#</span>
<span class="c1">#   edns_opt_list_append(edns_opt_list, code, data_bytearray, region): </span>
<span class="c1">#       Append the EDNS option with code and data_bytearray to the given</span>
<span class="c1">#           edns_opt_list.</span>
<span class="c1">#       NOTE: data_bytearray MUST be a Python bytearray.</span>
<span class="c1">#       Return True on success, False on failure.</span>
<span class="c1">#</span>
<span class="c1">#   edns_opt_list_remove(edns_opt_list, code):</span>
<span class="c1">#       Remove all occurrences of the given EDNS option code from the</span>
<span class="c1">#           edns_opt_list.</span>
<span class="c1">#       Return True when at least one EDNS option was removed, False otherwise.</span>
<span class="c1">#</span>
<span class="c1">#   register_edns_option(env, code, bypass_cache_stage=True,</span>
<span class="c1">#                        no_aggregation=True):</span>
<span class="c1">#       Register EDNS option code as a known EDNS option.</span>
<span class="c1">#       bypass_cache_stage:</span>
<span class="c1">#           bypasses answering from cache and allows the query to reach the</span>
<span class="c1">#           modules for further EDNS handling.</span>
<span class="c1">#       no_aggregation:</span>
<span class="c1">#           makes every query with the said EDNS option code unique.</span>
<span class="c1">#       Return True on success, False on failure.</span>
<span class="c1">#</span>
<span class="c1"># Examples on how to use the functions are given in this file.</span>


<span class="k">def</span> <span class="nf">init_standard</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;New version of the init function.</span>
<span class="sd">    The function&#39;s signature is the same as the C counterpart and allows for</span>
<span class="sd">    extra functionality during init.</span>
<span class="sd">    ..note:: This function is preferred by unbound over the old init function.</span>
<span class="sd">    ..note:: The previously accessible configuration options can now be found in</span>
<span class="sd">             env.cfg.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: inited script </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mod_env</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">]))</span>

    <span class="c1"># Register EDNS option 65001 as a known EDNS option.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">register_edns_option</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="mi">65001</span><span class="p">,</span> <span class="n">bypass_cache_stage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">no_aggregation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Previous version init function.</span>
<span class="sd">    ..note:: This function is still supported for backwards compatibility when</span>
<span class="sd">             the init_standard function is missing. When init_standard is</span>
<span class="sd">             present this function SHOULD be omitted to avoid confusion to the</span>
<span class="sd">             reader.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">deinit</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">inform_super</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">qstate</span><span class="p">,</span> <span class="n">superqstate</span><span class="p">,</span> <span class="n">qdata</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">qstate</span><span class="p">,</span> <span class="n">qdata</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_NEW</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_PASS</span><span class="p">):</span>
        <span class="c1"># Detect if EDNS option code 56001 is present from the client side. If</span>
        <span class="c1"># so turn on the flags for cache management.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in</span><span class="p">):</span>
            <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: searching for EDNS option code 65001 during NEW &quot;</span>
                     <span class="s2">&quot;or PASS event &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in_iter</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">65001</span><span class="p">:</span>
                    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: found EDNS option code 65001&quot;</span><span class="p">)</span>
                    <span class="c1"># Instruct other modules to not lookup for an</span>
                    <span class="c1"># answer in the cache.</span>
                    <span class="n">qstate</span><span class="o">.</span><span class="n">no_cache_lookup</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: enabled no_cache_lookup&quot;</span><span class="p">)</span>

                    <span class="c1"># Instruct other modules to not store the answer in</span>
                    <span class="c1"># the cache.</span>
                    <span class="n">qstate</span><span class="o">.</span><span class="n">no_cache_store</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: enabled no_cache_store&quot;</span><span class="p">)</span>

        <span class="c1">#Pass on the query</span>
        <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_WAIT_MODULE</span> 
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">MODULE_EVENT_MODDONE</span><span class="p">:</span>
        <span class="c1"># If the client sent EDNS option code 65001 and data &#39;c001&#39; reply</span>
        <span class="c1"># with the same code and data &#39;deadbeef&#39;.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in</span><span class="p">):</span>
            <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: searching for EDNS option code 65001 during &quot;</span>
                     <span class="s2">&quot;MODDONE&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in_iter</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">65001</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">bytearray</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;c001&quot;</span><span class="p">):</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;deadbeef&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_append</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_out</span><span class="p">,</span>
                                           <span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">qstate</span><span class="o">.</span><span class="n">region</span><span class="p">):</span>
                        <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_ERROR</span>
                        <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># List every EDNS option in all lists.</span>
        <span class="c1"># The available lists are:</span>
        <span class="c1">#   - qstate.edns_opts_front_in:  EDNS options that came from the</span>
        <span class="c1">#                                 client side. SHOULD NOT be changed;</span>
        <span class="c1">#</span>
        <span class="c1">#   - qstate.edns_opts_back_out:  EDNS options that will be sent to the</span>
        <span class="c1">#                                 server side. Can be populated by</span>
        <span class="c1">#                                 EDNS literate modules;</span>
        <span class="c1">#</span>
        <span class="c1">#   - qstate.edns_opts_back_in:   EDNS options that came from the</span>
        <span class="c1">#                                 server side. SHOULD NOT be changed;</span>
        <span class="c1">#</span>
        <span class="c1">#   - qstate.edns_opts_front_out: EDNS options that will be sent to the</span>
        <span class="c1">#                                 client side. Can be populated by</span>
        <span class="c1">#                                 EDNS literate modules;</span>
        <span class="c1">#</span>
        <span class="c1"># The lists&#39; contents can be accessed in python by their _iter</span>
        <span class="c1"># counterpart as an iterator.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in</span><span class="p">):</span>
            <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: EDNS options in edns_opts_front_in:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_in_iter</span><span class="p">:</span>
                <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python:    Code: </span><span class="si">{}</span><span class="s2">, Data: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_back_out</span><span class="p">):</span>
            <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: EDNS options in edns_opts_back_out:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_back_out_iter</span><span class="p">:</span>
                <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python:    Code: </span><span class="si">{}</span><span class="s2">, Data: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_back_in</span><span class="p">):</span>
            <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: EDNS options in edns_opts_back_in:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_back_in_iter</span><span class="p">:</span>
                <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python:    Code: </span><span class="si">{}</span><span class="s2">, Data: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edns_opt_list_is_empty</span><span class="p">(</span><span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_out</span><span class="p">):</span>
            <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python: EDNS options in edns_opts_front_out:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qstate</span><span class="o">.</span><span class="n">edns_opts_front_out_iter</span><span class="p">:</span>
                <span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;python:    Code: </span><span class="si">{}</span><span class="s2">, Data: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>

        <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_FINISHED</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">log_err</span><span class="p">(</span><span class="s2">&quot;pythonmod: Unknown event&quot;</span><span class="p">)</span>
    <span class="n">qstate</span><span class="o">.</span><span class="n">ext_state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODULE_ERROR</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">EDNS options</a><ul>
<li><a class="reference internal" href="#key-parts">Key parts</a><ul>
<li><a class="reference internal" href="#registering-edns-options">Registering EDNS options</a></li>
<li><a class="reference internal" href="#edns-option-lists">EDNS option lists</a><ul>
<li><a class="reference internal" href="#reading-an-edns-option-list">Reading an EDNS option list</a></li>
<li><a class="reference internal" href="#writing-to-an-edns-option-list">Writing to an EDNS option list</a></li>
</ul>
</li>
<li><a class="reference internal" href="#controlling-other-modules-cache-behavior">Controlling other modules’ cache behavior</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#complete-source-code">Complete source code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="example4.html"
                        title="previous chapter">DNS-based language dictionary</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="example6.html"
                        title="next chapter">Inplace callbacks</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="example6.html" title="Inplace callbacks"
             >next</a> |</li>
        <li class="right" >
          <a href="example4.html" title="DNS-based language dictionary"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Unbound scriptable interface 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Examples</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">EDNS options</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009, Zdenek Vasicek, Marek Vavrusa.
      Last updated on Nov 17, 2023.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>